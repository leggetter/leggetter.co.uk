<html>
  <head>
    <script src="../libs/LAB.min.js"></script>
    <script src="http://www.leggetter.co.uk/leggetter_js/js/leggetter/index.js"></script>
    <script>
      leggetter.namespace("Pusher.help.hash");
    
      Pusher.help.hash._loadDependencies = function(callback) {
        $LAB
          .script("../libs/json2.js")
          .script("http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js")
          .script("http://crypto-js.googlecode.com/files/2.2.0-crypto-sha256.js")
          .script("http://crypto-js.googlecode.com/files/2.2.0-hmac-min.js").wait(callback);
      };
      
      Pusher.help.hash._loadDependencies(function(){
        $("#generate_hash_btn").click(function() {
          var appKey = $("#app_key").val();
          var appSecret = $("#app_secret").val();
          var socketId = $("#socket_id").val();
          var channelName = $("#channel_name").val();
          var channelData = $("#channel_data").val();
          
          var auth = Pusher.help.hash._generateHash(appKey, appSecret, socketId, channelName, channelData, function(auth, stringToSign, authString) {
            $("#string_to_sign").val(stringToSign);
            $("#auth_string").val(authString);
            $("#auth_json").val(JSON.stringify(auth));
          });
          
          
          return false;
        })
      });
      
      Pusher.help.hash._generateHash = function(appKey, appSecret, socketId, channelName, channelDataString, callback) {
        var stringToSign = socketId + ":" + channelName + (channelDataString?":" + channelDataString:"");
        var hmac = Crypto.HMAC(Crypto.SHA256, stringToSign, appSecret);
        var authString = appKey + ":" + hmac;
        var auth =  {auth:authString};
        if(channelDataString) {
          auth.channel_data = channelDataString;
        }
        callback(auth, stringToSign, authString);
      };
    </script>
    
    <style type="text/css">
      .section {
        overflow: auto;
        clear: both;
      }
      .section label, .section input, .section textarea {
        float: left;
        width: 400px;
      }
      .section label {
        clear: left;
        width: 200px;
        height: 45px;
      }
      
      .input textarea, .output textarea {
        width: 400px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <h1>Pusher Auth Hash Checker</h1>
    
    <div class="input section">
      <h2>Input</h2>
      <label for="app_key">App Key:</label><input type="text" id="app_key" value="006c79b1fe1700c6c10d" />
      <label for="app_secret">App Secret (Don't share this with anybody)</label><input type="text" id="app_secret" />
      <label for="socket_id">Socket ID</label><input type="text" id="socket_id" value="1289.861100" />
      <label for="channel_name">Channel Name</label><input type="text" id="channel_name" value="presence-PusherTShirt_Blue" />
      <label for="channel_data">Channel Data (JSON)</label><input type="text" id="channel_data" value='{"user_id":"Guest 1","user_info":{"timestamp":634479805683037110}}' />
      <button id="generate_hash_btn">Generate Hash</button>
    </div>
    
    <div class="output section">
      <h2>Output</h2>
      <label for="string_to_sign">String to Sign:</label><textarea id="string_to_sign"></textarea>
      <label for="auth_string">Auth String:</label><textarea id="auth_string"></textarea>
      <label for="auth_json">Auth JSON:</label><textarea id="auth_json"></textarea>
      
    </div>
  </body>
</html>