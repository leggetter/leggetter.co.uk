var Firepad=function(){var t=t||{};t.utils={},t.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;r.length>n;n++)if(r[n].callback===e)return r.splice(n,1),void 0},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;e.length>r;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_&&-1===this.allowedEvents_.indexOf(t))throw Error('Unknown event "'+t+'"')}},t.utils.elt=function(e,r,n){var i=document.createElement(e);if("string"==typeof r)t.utils.setTextContent(i,r);else if(r)for(var o=0;r.length>o;++o)i.appendChild(r[o]);for(var s in n||{})i.setAttribute(s,n[s]);return i},t.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},t.utils.on=function(t,e,r,n){t.addEventListener?t.addEventListener(e,r,n||!1):t.attachEvent&&t.attachEvent("on"+e,r)},t.utils.off=function(t,e,r,n){t.removeEventListener?t.removeEventListener(e,r,n||!1):t.detachEvent&&t.detachEvent("on"+e,r)},t.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},t.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},t.utils.stopEvent=function(e){t.utils.preventDefault(e),t.utils.stopPropagation(e)},t.utils.stopEventAnd=function(e){return function(r){return e(r),t.utils.stopEvent(r),!1}},t.utils.assert=function(t,e){if(!t)throw Error(e||"assertion error")},t.utils.log=function(){if("undefined"!=typeof console&&console.log!==void 0){for(var t=["Firepad:"],e=0;arguments.length>e;e++)t.push(arguments[e]);console.log.apply(console,t)}};var t=t||{};t.Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}();var t=t||{};t.TextOp=function(){function e(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],r.assert("string"==typeof this.text),this.attributes=arguments[2]||{},r.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],r.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],r.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},r.assert("object"==typeof this.attributes))}var r=t.utils;return e.prototype.isInsert=function(){return"insert"===this.type},e.prototype.isDelete=function(){return"delete"===this.type},e.prototype.isRetain=function(){return"retain"===this.type},e.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},e.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},e.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},e}();var t=t||{};t.TextOperation=function(){"use strict";function e(){return this&&this.constructor===e?(this.ops=[],this.baseLength=0,this.targetLength=0,void 0):new e}function r(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function n(t){return t.ops[0].isRetain()?t.ops[0].chars:0}var i=t.TextOp,o=t.utils;return e.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;this.ops.length>e;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},e.prototype.retain=function(t,e){if("number"!=typeof t||0>t)throw Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,e=e||{};var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isRetain()&&r.attributesEqual(e)?r.chars+=t:this.ops.push(new i("retain",t,e)),this},e.prototype.insert=function(t,e){if("string"!=typeof t)throw Error("insert expects a string");if(""===t)return this;e=e||{},this.targetLength+=t.length;var r=this.ops.length>0?this.ops[this.ops.length-1]:null,n=this.ops.length>1?this.ops[this.ops.length-2]:null;return r&&r.isInsert()&&r.attributesEqual(e)?r.text+=t:r&&r.isDelete()?n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:(this.ops[this.ops.length-1]=new i("insert",t,e),this.ops.push(r)):this.ops.push(new i("insert",t,e)),this},e.prototype["delete"]=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||0>t)throw Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var e=this.ops.length>0?this.ops[this.ops.length-1]:null;return e&&e.isDelete()?e.chars+=t:this.ops.push(new i("delete",t)),this},e.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},e.prototype.clone=function(){for(var t=new e,r=0;this.ops.length>r;r++)this.ops[r].isRetain()?t.retain(this.ops[r].chars,this.ops[r].attributes):this.ops[r].isInsert()?t.insert(this.ops[r].text,this.ops[r].attributes):t["delete"](this.ops[r].chars);return t},e.prototype.toString=function(){var t=Array.prototype.map||function(t){for(var e=this,r=[],n=0,i=e.length;i>n;n++)r[n]=t(e[n]);return r};return t.call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},e.prototype.toJSON=function(){for(var t=[],e=0;this.ops.length>e;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},e.fromJSON=function(t){for(var r=new e,n=0,i=t.length;i>n;n++){var s=t[n],a={};"object"==typeof s&&(a=s,n++,s=t[n]),"number"==typeof s?s>0?r.retain(s,a):r["delete"](-s):(o.assert("string"==typeof s),r.insert(s,a))}return r},e.prototype.apply=function(t,e,r){var n=this;if(e=e||[],r=r||[],t.length!==n.baseLength)throw Error("The operation's base length must be equal to the string's length.");for(var i,s,a=[],h=0,u=0,c=this.ops,p=0,l=c.length;l>p;p++){var f=c[p];if(f.isRetain()){if(u+f.chars>t.length)throw Error("Operation can't retain more characters than are left in the string.");for(a[h++]=t.slice(u,u+f.chars),i=0;f.chars>i;i++){var d=e[u+i]||{},g={};for(s in d)g[s]=d[s],o.assert(g[s]!==!1);for(s in f.attributes)f.attributes[s]===!1?delete g[s]:g[s]=f.attributes[s],o.assert(g[s]!==!1);r.push(g)}u+=f.chars}else if(f.isInsert())for(a[h++]=f.text,i=0;f.text.length>i;i++){var v={};for(s in f.attributes)v[s]=f.attributes[s],o.assert(v[s]!==!1);r.push(v)}else u+=f.chars}if(u!==t.length)throw Error("The operation didn't operate on the whole string.");var m=a.join("");return o.assert(m.length===r.length),m},e.prototype.invert=function(t){for(var r=0,n=new e,i=this.ops,o=0,s=i.length;s>o;o++){var a=i[o];a.isRetain()?(n.retain(a.chars),r+=a.chars):a.isInsert()?n["delete"](a.text.length):(n.insert(t.slice(r,r+a.chars)),r+=a.chars)}return n},e.prototype.compose=function(t){function r(t,e,r){var n,i={};for(n in t)i[n]=t[n];for(n in e)r&&e[n]===!1?delete i[n]:i[n]=e[n];return i}var n=this;if(n.targetLength!==t.baseLength)throw Error("The base length of the second operation has to be the target length of the first operation");for(var i,o=new e,s=n.clone().ops,a=t.clone().ops,h=0,u=0,c=s[h++],p=a[u++];;){if(c===void 0&&p===void 0)break;if(c&&c.isDelete())o["delete"](c.chars),c=s[h++];else if(p&&p.isInsert())o.insert(p.text,p.attributes),p=a[u++];else{if(c===void 0)throw Error("Cannot compose operations: first operation is too short.");if(p===void 0)throw Error("Cannot compose operations: first operation is too long.");if(c.isRetain()&&p.isRetain())i=r(c.attributes,p.attributes),c.chars>p.chars?(o.retain(p.chars,i),c.chars-=p.chars,p=a[u++]):c.chars===p.chars?(o.retain(c.chars,i),c=s[h++],p=a[u++]):(o.retain(c.chars,i),p.chars-=c.chars,c=s[h++]);else if(c.isInsert()&&p.isDelete())c.text.length>p.chars?(c.text=c.text.slice(p.chars),p=a[u++]):c.text.length===p.chars?(c=s[h++],p=a[u++]):(p.chars-=c.text.length,c=s[h++]);else if(c.isInsert()&&p.isRetain())i=r(c.attributes,p.attributes,!0),c.text.length>p.chars?(o.insert(c.text.slice(0,p.chars),i),c.text=c.text.slice(p.chars),p=a[u++]):c.text.length===p.chars?(o.insert(c.text,i),c=s[h++],p=a[u++]):(o.insert(c.text,i),p.chars-=c.text.length,c=s[h++]);else{if(!c.isRetain()||!p.isDelete())throw Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(p));c.chars>p.chars?(o["delete"](p.chars),c.chars-=p.chars,p=a[u++]):c.chars===p.chars?(o["delete"](p.chars),c=s[h++],p=a[u++]):(o["delete"](c.chars),p.chars-=c.chars,c=s[h++])}}}return o},e.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=n(this),i=n(t),o=r(this),s=r(t);return o&&s?o.isInsert()&&s.isInsert()?e+o.text.length===i:o.isDelete()&&s.isDelete()?i+s.chars===e||e===i:!1:!1},e.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=n(this),i=n(t),o=r(this),s=r(t);return o&&s?o.isInsert()&&s.isInsert()?e+o.text.length===i||e===i:o.isDelete()&&s.isDelete()?i+s.chars===e:!1:!1},e.transformAttributes=function(t,e){var r,n={},i={},s={};for(r in t)s[r]=!0;for(r in e)s[r]=!0;for(r in s){var a=t[r],h=e[r];o.assert(null!=a||null!=h),null==a?i[r]=h:null==h?n[r]=a:a===h||(n[r]=a)}return[n,i]},e.transform=function(t,r){if(t.baseLength!==r.baseLength)throw Error("Both operations have to have the same base length");for(var n=new e,i=new e,o=t.clone().ops,s=r.clone().ops,a=0,h=0,u=o[a++],c=s[h++];;){if(u===void 0&&c===void 0)break;if(u&&u.isInsert())n.insert(u.text,u.attributes),i.retain(u.text.length),u=o[a++];else if(c&&c.isInsert())n.retain(c.text.length),i.insert(c.text,c.attributes),c=s[h++];else{if(u===void 0)throw Error("Cannot transform operations: first operation is too short.");if(c===void 0)throw Error("Cannot transform operations: first operation is too long.");var p;if(u.isRetain()&&c.isRetain()){var l=e.transformAttributes(u.attributes,c.attributes);u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),n.retain(p,l[0]),i.retain(p,l[1])}else if(u.isDelete()&&c.isDelete())u.chars>c.chars?(u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(u=o[a++],c=s[h++]):(c.chars-=u.chars,u=o[a++]);else if(u.isDelete()&&c.isRetain())u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),n["delete"](p);else{if(!u.isRetain()||!c.isDelete())throw Error("The two operations aren't compatible");u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=u.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),i["delete"](p)}}}return[n,i]},e}();var t=t||{};t.AnnotationList=function(){function e(t,e){if(!t)throw Error("AnnotationList assertion failed"+(e?": "+e:""))}function r(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}function i(t){this.head_=new o(0,a),this.changeHandler_=t}function o(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}var s=t.Span;r.prototype.getAttachedObject=function(){return this.attachedObject_},n.prototype.attachObject=function(t){this.node_.attachedObject=t};var a={equals:function(){return!1}};return i.prototype.insertAnnotatedSpan=function(t,r){this.wrapOperation_(new s(t.pos,0),function(n,i){e(!i||null===i.next);var s=new o(t.length,r);if(i){e(t.pos>n&&t.pos<n+i.length);var h=new o(0,a);return h.next=new o(t.pos-n,i.annotation),h.next.next=s,s.next=new o(n+i.length-t.pos,i.annotation),h.next}return s})},i.prototype.removeSpan=function(t){0!==t.length&&this.wrapOperation_(t,function(r,n){e(null!==n);var i=new o(0,a),s=i;for(t.pos>r&&(s.next=new o(t.pos-r,n.annotation),s=s.next);t.end()>r+n.length;)r+=n.length,n=n.next;var h=r+n.length-t.end();return h>0&&(s.next=new o(h,n.annotation)),i.next})},i.prototype.updateSpan=function(t,r){0!==t.length&&this.wrapOperation_(t,function(n,i){e(null!==i);var s=new o(0,a),h=s,u=n,c=t.pos-u;for(e(i.length>c),c>0&&(h.next=new o(c,i.annotation),h=h.next,u+=h.length);null!==i&&t.end()>=n+i.length;){var p=n+i.length-u;h.next=new o(p,r(i.annotation,p)),h=h.next,n+=i.length,i=i.next,u=n}var l=t.end()-u;return l>0&&(e(i.length>l),h.next=new o(l,r(i.annotation,l)),h=h.next,u+=h.length,h.next=new o(n+i.length-u,i.annotation)),s.next})},i.prototype.wrapOperation_=function(t,e){if(0>t.pos)throw Error("Span start cannot be negative.");var i,s=[],a=[],h=this.getAffectedNodes_(t);null!==h.start?(i=h.end.next,h.end.next=null):i=h.succ;var u=e(h.startPos,h.start),c=!1,p=!1;if(u){this.mergeNodesWithSameAnnotations_(u);var l;for(h.pred&&h.pred.annotation.equals(u.annotation)?(c=!0,u.length+=h.pred.length,h.beforePred.next=u,l=h.predPos):(h.beforeStart.next=u,l=h.startPos);u.next;)a.push(new n(l,u)),l+=u.length,u=u.next;h.succ&&h.succ.annotation.equals(u.annotation)?(u.length+=h.succ.length,p=!0,u.next=h.succ.next):u.next=i,a.push(new n(l,u))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(c=!0,p=!0,u=new o(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=u,u.next=h.succ.next,a.push(new n(h.startPos-h.start.length,u))):h.beforeStart.next=i;c&&s.push(new r(h.predPos,h.pred));for(var f=h.startPos,d=h.start;null!==d;)s.push(new r(f,d)),f+=d.length,d=d.next;p&&s.push(new r(f,h.succ)),this.changeHandler_(s,a)},i.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,i=n.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,r=n,n=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,e.start=0===t.length&&t.pos===o?null:i,e.beforeStart=n,o===t.pos&&o>0?(e.pred=n,e.predPos=o-n.length,e.beforePred=r):e.pred=null;null!==i&&t.end()>o;)o+=i.length,n=i,i=i.next;if(t.end()>o)throw Error("Span end exceeds the bounds of the AnnotationList.");return e.end=0===t.length&&t.end()===o?null:n,e.succ=o===t.end()?i:null,e},i.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},i.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},i.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,n=this.head_.next,i=null;null!==n&&t>=e+n.length;)e+=n.length,i=n,n=n.next;if(null===n&&e!==t)throw Error("pos exceeds the bounds of the AnnotationList");var o=[];return e===t&&i&&o.push(new r(e-i.length,i)),n&&o.push(new r(e,n)),o},i.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var e=[],r=this.getAffectedNodes_(t),n=r.startPos,i=r.start;null!==i&&t.end()>n;){var o=Math.max(n,t.pos),a=Math.min(n+i.length,t.end()),h=new s(o,a-o);h.annotation=i.annotation,e.push(h),n+=i.length,i=i.next}return e},i.prototype.count=function(){for(var t=0,r=this.head_.next,n=null;null!==r;)n&&e(!n.annotation.equals(r.annotation)),n=r,r=r.next,t++;return t},o.prototype.clone=function(){var t=new o(this.spanLength,this.annotation);return t.next=this.next,t},i}();var t=t||{};t.Cursor=function(){"use strict";function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function r(t){for(var r=t,n=e.ops,i=0,o=e.ops.length;o>i&&(n[i].isRetain()?t-=n[i].chars:n[i].isInsert()?r+=n[i].text.length:(r-=Math.min(t,n[i].chars),t-=n[i].chars),!(0>t));i++);return r}var n=r(this.position);return this.position===this.selectionEnd?new t(n,n):new t(n,r(this.selectionEnd))},t}();var t=t||{};t.FirebaseAdapter=function(){function e(t,e,r){this.ref_=t,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new o,this.revision_=0,this.pendingReceivedRevisions_={},this.setUserId(e),this.setColor(r);var n=this;this.firebaseOn_(t.root().child(".info/connected"),"value",function(t){t.val()===!0&&n.initializeUserData_()},this),setTimeout(function(){n.monitorHistory_()},0),this.on("ready",function(){n.monitorCursors_()})}function r(t,e){if(!t)throw Error(e||"assertion error")}function n(t){if(0===t)return"A0";for(var e="";t>0;){var r=t%h.length;e=h[r]+e,t-=r,t/=h.length}var n=h[e.length+9];return n+e}function i(t){r(t.length>0&&t[0]===h[t.length+8]);for(var e=0,n=1;t.length>n;n++)e*=h.length,e+=h.indexOf(t[n]);return e}var o=t.TextOperation,s=t.utils,a=100;s.makeEventEmitter(e,["ready","cursor","operation","ack","retry"]),e.prototype.dispose=function(){this.removeFirebaseCallbacks_(),this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove(),this.ref_=null,this.document_=null,this.zombie_=!0},e.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},e.prototype.isHistoryEmpty=function(){return r(this.ready_,"Not ready yet."),0===this.revision_},e.prototype.sendOperation=function(t,e){function i(t,e,r){o.ref_.child("history").child(t).transaction(function(t){return null===t?e:void 0},function(n,a){if(n){if("disconnect"!==n.message)throw s.log("Transaction failure!",n),n;o.sent_&&o.sent_.id===t&&setTimeout(function(){i(t,e,r)},0)}else a&&o.sendCursor(r)},!1)}var o=this;if(!this.ready_)return this.on("ready",function(){o.trigger("retry")}),void 0;r(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation.");var a=n(this.revision_);this.sent_={id:a,op:t},i(a,{a:o.userId_,o:t.toJSON()},e)},e.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},e.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},e.prototype.getDocument=function(){return this.document_},e.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},e.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},e.prototype.monitorCursors_=function(){function t(t){var e=t.name();if(e!==r.userId_){var n=t.val();r.trigger("cursor",e,n.cursor,n.color)}}var e=this.ref_.child("users"),r=this,n={};this.firebaseOn_(e,"child_added",t),this.firebaseOn_(e,"child_changed",t),this.firebaseOn_(e,"child_removed",function(t){var e=t.name();r.firebaseOff_(t.ref(),"value",n[e]),r.trigger("cursor",e,null)})},e.prototype.monitorHistory_=function(){var t=this;this.ref_.child("checkpoint").once("value",function(e){if(!t.zombie_){var r=e.child("id").val(),n=e.child("o").val(),o=e.child("a").val();null!=n&&null!=r&&null!==o?(t.pendingReceivedRevisions_[r]={o:n,a:o},t.checkpointRevision_=i(r),t.monitorHistoryStartingAt_(t.checkpointRevision_+1)):(t.checkpointRevision_=0,t.monitorHistoryStartingAt_(t.checkpointRevision_))}})},e.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,n(t)),r=this;setTimeout(function(){r.firebaseOn_(e,"child_added",function(t){var e=t.name();r.pendingReceivedRevisions_[e]=t.val(),r.ready_&&r.handlePendingReceivedRevisions_()}),e.once("value",function(){r.handleInitialRevisions_()})},0)},e.prototype.handleInitialRevisions_=function(){r(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=n(this.revision_),e=this.pendingReceivedRevisions_;null!=e[t];){var i=this.parseRevision_(e[t]);i?this.document_=this.document_.compose(i.operation):s.log("Invalid operation.",""+this.ref_,t,e[t]),delete e[t],this.revision_++,t=n(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var o=this;setTimeout(function(){o.trigger("ready")},0)},e.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=n(this.revision_),r=!1;null!=t[e];){this.revision_++;var i=this.parseRevision_(t[e]);i?(this.document_=this.document_.compose(i.operation),this.sent_&&e===this.sent_.id?this.sent_.op.equals(i.operation)&&i.author===this.userId_?(0===this.revision_%a&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(r=!0,this.trigger("operation",i.operation)):this.trigger("operation",i.operation)):s.log("Invalid operation.",""+this.ref_,e,t[e]),delete t[e],e=n(this.revision_)}r&&(this.sent_=null,this.trigger("retry"))},e.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var e=null;try{e=o.fromJSON(t.o)}catch(r){return null}return e.baseLength!==this.document_.targetLength?null:{author:t.a,operation:e}},e.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:n(this.revision_-1)})},e.prototype.firebaseOn_=function(t,e,r,n){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:r,context:n}),t.on(e,r,n),r},e.prototype.firebaseOff_=function(t,e,r,n){t.off(e,r,n);for(var i=0;this.firebaseCallbacks_.length>i;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===r&&o.context===n){this.firebaseCallbacks_.splice(i,1);break}}},e.prototype.removeFirebaseCallbacks_=function(){for(var t=0;this.firebaseCallbacks_.length>t;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]};var h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return e}();var t=t||{};t.RichTextToolbar=function(){function e(){this.element_=this.makeElement_()}var r=t.utils;return r.makeEventEmitter(e,["bold","italic","underline","font","font-size","color","unordered-list","ordered-list","todo"]),e.prototype.element=function(){return this.element_},e.prototype.makeElement_=function(){var t=this,e=r.elt("a","B",{"class":"firepad-btn firepad-btn-bold"});r.on(e,"click",r.stopEventAnd(function(){t.trigger("bold")}));var n=r.elt("a","I",{"class":"firepad-btn firepad-btn-italic"});r.on(n,"click",r.stopEventAnd(function(){t.trigger("italic")}));var i=r.elt("a","U",{"class":"firepad-btn firepad-btn-underline"});r.on(i,"click",r.stopEventAnd(function(){t.trigger("underline")}));var o=r.elt("a",[r.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-ul"});r.on(o,"click",r.stopEventAnd(function(){t.trigger("unordered-list")}));var s=r.elt("a",[r.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-ol"});r.on(s,"click",r.stopEventAnd(function(){t.trigger("ordered-list")}));var a=r.elt("a",[r.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-todo"});r.on(a,"click",r.stopEventAnd(function(){t.trigger("todo")}));var h=this.makeFontDropdown_(),u=this.makeFontSizeDropdown_(),c=this.makeColorDropdown_(),p=r.elt("div",[r.elt("div",[h],{"class":"firepad-btn-group"}),r.elt("div",[u],{"class":"firepad-btn-group"}),r.elt("div",[c],{"class":"firepad-btn-group"}),r.elt("div",[e,n,i],{"class":"firepad-btn-group"}),r.elt("div",[o,s],{"class":"firepad-btn-group"})],{"class":"firepad-toolbar"});return p},e.prototype.makeFontDropdown_=function(){for(var t=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],e=[],n=0;t.length>n;n++){var i=r.elt("span",t[n]);i.setAttribute("style","font-family:"+t[n]),e.push({content:i,value:t[n]})}return this.makeDropdown_("Font","font",e)},e.prototype.makeFontSizeDropdown_=function(){for(var t=[9,10,12,14,18,24,32,42],e=[],n=0;t.length>n;n++){var i=r.elt("span",""+t[n]);i.setAttribute("style","font-size:"+t[n]+"px; line-height:"+(t[n]-6)+"px;"),e.push({content:i,value:t[n]})}return this.makeDropdown_("Size","font-size",e,"px")},e.prototype.makeColorDropdown_=function(){for(var t=["black","red","green","blue","yellow","cyan","magenta","grey"],e=[],n=0;t.length>n;n++){var i=r.elt("div");i.className="firepad-color-dropdown-item",i.setAttribute("style","background-color:"+t[n]),e.push({content:i,value:t[n]})}return this.makeDropdown_("Color","color",e)},e.prototype.makeDropdown_=function(t,e,n,i){function o(){p||(c.style.display="block",r.on(document,"click",s,!0),p=!0)}function s(){p&&(c.style.display="",r.off(document,"click",s,!0),p=!1),l=!0,setTimeout(function(){l=!1},0)}function a(t,n){"object"!=typeof t&&(t=document.createTextNode(t+""));var o=r.elt("a",[t]);r.on(o,"click",r.stopEventAnd(function(){s(),h.trigger(e,n+i)})),c.appendChild(o)}i=i||"";var h=this,u=r.elt("a",t+" ▾",{"class":"firepad-btn firepad-dropdown"}),c=r.elt("ul",[],{"class":"firepad-dropdown-menu"});u.appendChild(c);for(var p=!1,l=!1,f=0;n.length>f;f++){var d=n[f].content,g=n[f].value;a(d,g)}return r.on(u,"click",r.stopEventAnd(function(){l||o()})),u},e}();var t=t||{};t.WrappedOperation=function(){"use strict";function t(t,e){this.wrapped=t,this.meta=e}function e(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function r(t,r){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(r);var n={};return e(t,n),e(r,n),n}return r}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.meta;return new t(this.wrapped.invert.apply(this.wrapped,arguments),e&&"object"==typeof e&&"function"==typeof e.invert?e.invert.apply(e,arguments):e)},t.prototype.compose=function(e){return new t(this.wrapped.compose(e.wrapped),r(this.meta,e.meta))},t.transform=function(e,r){var i=e.wrapped.constructor.transform,o=i(e.wrapped,r.wrapped);return[new t(o[0],n(e.meta,r.wrapped)),new t(o[1],n(r.meta,e.wrapped))]},t}();var t=t||{};t.UndoManager=function(){"use strict";function t(t){this.maxItems=t||50,this.state=r,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(t,e){for(var r=[],n=e.constructor,i=t.length-1;i>=0;i--){var o=n.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||r.push(o[0]),e=o[1]}return r.reverse()}var r="normal",n="undoing",i="redoing";return t.prototype.add=function(t,e){if(this.state===n)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===i)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=e(this.undoStack,t),this.redoStack=e(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=n,0===this.undoStack.length)throw Error("undo not possible");t(this.undoStack.pop()),this.state=r},t.prototype.performRedo=function(t){if(this.state=i,0===this.redoStack.length)throw Error("redo not possible");t(this.redoStack.pop()),this.state=r},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===n},t.prototype.isRedoing=function(){return this.state===i},t}();var t=t||{};t.Client=function(){"use strict";function t(){this.state=i}function e(){}function r(t){this.outstanding=t}function n(t,e){this.outstanding=t,this.buffer=e}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.transformCursor=function(t){return this.state.transformCursor(t)},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(){throw Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(){throw Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(e),new r(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(){throw Error("There is no pending operation.")},e.prototype.serverRetry=function(){throw Error("There is no pending operation.")},e.prototype.transformCursor=function(t){return t};var i=new e;return t.AwaitingConfirm=r,r.prototype.applyClient=function(t,e){return new n(this.outstanding,e)},r.prototype.applyServer=function(t,e){var n=e.constructor.transform(this.outstanding,e);return t.applyOperation(n[1]),new r(n[0])},r.prototype.serverAck=function(){return i},r.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},r.prototype.transformCursor=function(t){return t.transform(this.outstanding)},t.AwaitingWithBuffer=n,n.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new n(this.outstanding,r)},n.prototype.applyServer=function(t,e){var r=e.constructor.transform,i=r(this.outstanding,e),o=r(this.buffer,i[1]);return t.applyOperation(o[1]),new n(i[0],o[0])},n.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new r(e)},n.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new r(this.buffer)},n.prototype.transformCursor=function(t){return t.transform(this.outstanding).transform(this.buffer)},t}();var t=t||{};t.EditorClient=function(){"use strict";function e(t,e){this.cursorBefore=t,this.cursorAfter=e}function r(t,e){this.id=t,this.editorAdapter=e,this.li=document.createElement("li")}function n(t,e){s.call(this),this.serverAdapter=t,this.editorAdapter=e,this.undoManager=new h,this.clients={};var r=this;this.editorAdapter.registerCallbacks({change:function(t,e){r.onChange(t,e)},cursorActivity:function(){r.onCursorActivity()},blur:function(){r.onBlur()}}),this.editorAdapter.registerUndo(function(){r.undo()}),this.editorAdapter.registerRedo(function(){r.redo()}),this.serverAdapter.registerCallbacks({ack:function(){r.serverAck()},retry:function(){r.serverRetry()},operation:function(t){r.applyServer(t)},cursor:function(t,e,n){var i=r.getClientObject(t);e?(i.setColor(n),i.updateCursor(r.transformCursor(a.fromJSON(e)))):i.removeCursor()}})}function i(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}function o(t){return t[t.length-1]}var s=t.Client,a=t.Cursor,h=t.UndoManager,u=t.WrappedOperation;return e.prototype.invert=function(){return new e(this.cursorAfter,this.cursorBefore)},e.prototype.compose=function(t){return new e(this.cursorBefore,t.cursorAfter)},e.prototype.transform=function(t){return new e(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},r.prototype.setColor=function(t){this.color=t},r.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},r.prototype.removeCursor=function(){this.mark&&this.mark.clear()},i(n,s),n.prototype.getClientObject=function(t){var e=this.clients[t];return e?e:this.clients[t]=new r(t,this.editorAdapter)},n.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)
},n.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},n.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},n.prototype.onChange=function(t,r){var n=this.cursor;this.updateCursor();var i=this.undoManager.undoStack.length>0&&r.shouldBeComposedWithInverted(o(this.undoManager.undoStack).wrapped),s=new e(this.cursor,n);this.undoManager.add(new u(r,s),i),this.applyClient(t)},n.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},n.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},n.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},n.prototype.sendCursor=function(t){this.state instanceof s.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},n.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t,this.cursor)},n.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new u(t,null))},n}();var t=t||{};t.AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",FONT:"f",FONT_SIZE:"fs",COLOR:"c",LINE_SENTINEL:"l",LINE_INDENT:"li",LIST_TYPE:"lt"};var t=t||{};t.RichTextCodeMirror=function(){function e(t,e){this.codeMirror=t,this.options_=e||{},this.currentAttributes_=null;var r=this;this.annotationList_=new o(function(t,e){r.onAnnotationsChanged_(t,e)}),this.initAnnotationList_(),i(this,"onCodeMirrorBeforeChange_"),i(this,"onCodeMirrorChange_"),i(this,"onCursorActivity_"),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={}}function r(t){this.attributes=t||{}}function n(t){for(var e in t)return!1;return!0}function i(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}var o=t.AnnotationList,s=t.Span,a=t.utils,h=t.AttributeConstants,u="cmrt-",c="cmrt-",p={c:"color",fs:"font-size"},l={};a.makeEventEmitter(e,["change","attributesChange"]);var f="";return e.LineSentinelCharacter=f,e.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},e.prototype.toggleAttribute=function(t){if(this.emptySelection_()){var e=this.getCurrentAttributes_();e[t]===!0?delete e[t]:e[t]=!0,this.currentAttributes_=e}else{var r=this.getCurrentAttributes_(),n=r[t]!==!0;this.setAttribute(t,n)}},e.prototype.setAttribute=function(t,e){var r=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();e===!1?delete n[t]:n[t]=e,this.currentAttributes_=n}else this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),function(r){e===!1?delete r[t]:r[t]=e}),this.updateCurrentAttributes_()},e.prototype.updateTextAttributes=function(t,e,i,o){var a={},h=a,u=t,c=this;this.annotationList_.updateSpan(new s(t,e-t),function(t,e){var s={};for(var a in t.attributes)s[a]=t.attributes[a];i(s);var p={},l={};return c.computeChangedAttributes_(t.attributes,s,p,l),n(p)||(h.next={start:u,end:u+e,attributes:p,attributesInverse:l,origin:o},h=h.next),u+=e,new r(s)}),a.next&&this.trigger("attributesChange",this,a.next)},e.prototype.computeChangedAttributes_=function(t,e,r,n){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(r[i]=e[i],n[i]=t[i]):(r[i]=e[i],n[i]=!1):(r[i]=!1,n[i]=t[i])},e.prototype.toggleLineAttribute=function(t,e){var r,n=this.getCurrentLineAttributes_();r=t in n&&n[t]===e?!1:e,this.setLineAttribute(t,r)},e.prototype.setLineAttribute=function(t,e){this.updateLineAttributesForSelection(function(r){e===!1?delete r[t]:r[t]=e})},e.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,r=e.getCursor("start"),n=e.getCursor("end"),i=r.line,o=n.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,n.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)},e.prototype.updateLineAttributes=function(t,e,r){for(var n=t;e>=n;n++){var i=this.codeMirror.getLine(n),o=this.codeMirror.indexFromPos({line:n,ch:0});if(i[0]!==f){var s={};s[h.LINE_SENTINEL]=!0,r(s),this.insertText(o,f,s)}else this.updateTextAttributes(o,o+1,r)}},e.prototype.replaceText=function(t,e,r,n,i){this.changeId_++;var o=c+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:n};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(r,a,h,o)},e.prototype.insertText=function(t,e,r,n){this.replaceText(t,null,e,r,n)},e.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},e.prototype.getAttributeSpans=function(t,e){for(var r=[],n=this.annotationList_.getAnnotatedSpansForSpan(new s(t,e-t)),i=0;n.length>i;i++)r.push({length:n[i].length,attributes:n[i].annotation.attributes});return r},e.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},e.prototype.getText=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},e.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new s(0,t),new r)},e.prototype.onAnnotationsChanged_=function(t,e){for(var r,n={},i=0;t.length>i;i++){var o=t[i].annotation.attributes;h.LINE_SENTINEL in o&&(n[this.codeMirror.posFromIndex(t[i].pos).line]=!0),r=t[i].getAttachedObject(),r&&r.clear()}for(i=0;e.length>i;i++){var s=e[i].annotation,a=this.getClassNameForAttributes_(s.attributes),u=h.LINE_SENTINEL in s.attributes;if(""!==a){var c=this.codeMirror.posFromIndex(e[i].pos);if(u)n[c.line]=!0;else{var p=this.codeMirror.posFromIndex(e[i].pos+e[i].length);r=this.codeMirror.markText(c,p,{className:a}),e[i].attachObject(r)}}}for(var l in n)(function(t,e){setTimeout(function(){var r=t.codeMirror.getLineNumber(e);t.markLineSentinelCharactersForChangedLines_(r,r)},0)})(this,this.codeMirror.getLineHandle(Number(l)))},e.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t)),e.appendChild(r)},e.prototype.getClassNameForAttributes_=function(e){var r="";for(var n in e){var i=e[n];if(n===h.LINE_SENTINEL)t.utils.assert(i===!0,"LINE_SENTINEL attribute should be true if it exists.");else{var o=(this.options_.cssPrefix||u)+n;if(i!==!0){n!==h.FONT_SIZE||"string"==typeof i&&-1!==i.indexOf("px",i.length-2)||(i+="px");var s=(""+i).toLowerCase().replace(/[^a-z0-9-_]/g,"-");o+="-"+s,p[n]&&(l[n]||(l[n]={}),l[n][s]||(l[n][s]=!0,this.addStyleWithCSS_("."+o+"{"+p[n]+":"+i+"}")))}r=r+" "+o}}return r},e.prototype.lineClassRemover_=function(t){var e=this.codeMirror,r=e.getLineHandle(t);return{clear:function(){e.removeLineClass(r,"text",".*")}}},e.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},e.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var r=[],n=0;e.text.length>n;n++){var i=e.text[n];i=i.replace(RegExp(f,"g"),""),r.push(i)}e.update(e.from,e.to,r)}},e.prototype.onCodeMirrorChange_=function(t,e){for(var n={},i=n,o=e;o;){var a=this.codeMirror.indexFromPos(o.from),h=o.removed.join("\n");if(h.length>0){for(var u=this.annotationList_.getAnnotatedSpansForSpan(new s(a,h.length)),c=0,p=0;u.length>p;p++){var l=u[p];i.next={start:a,end:a+l.length,removedAttributes:l.annotation.attributes,removed:h.substr(c,l.length),attributes:{},text:"",origin:o.origin},i=i.next,c+=l.length}this.annotationList_.removeSpan(new s(a,h.length))}var f=o.text.join("\n"),d=o.origin;if(f.length>0){var g;"+input"===o.origin||"paste"===o.origin?g=this.currentAttributes_||{}:d in this.outstandingChanges_?(g=this.outstandingChanges_[d].attributes,d=this.outstandingChanges_[d].origOrigin,delete this.outstandingChanges_[d]):g={},this.annotationList_.insertAnnotatedSpan(new s(a,f.length),new r(g)),i.next={start:a,end:a,removedAttributes:{},removed:"",text:f,attributes:g,origin:d},i=i.next}o=o.next}this.markLineSentinelCharactersForChanges_(e),n.next&&this.trigger("change",this,n.next)},e.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,r=-1,n=t;n;){var i=n.from.line;n.from.ch,(n.removed.length>1||n.removed[0].indexOf(f)>=0)&&(e=Math.min(e,i),r=Math.max(r,i)),n.text.length>1?(e=Math.min(e,i),r=Math.max(r,i+n.text.length-1)):n.text[0].indexOf(f)>=0&&(e=Math.min(e,i),r=Math.max(r,i)),n=n.next}this.markLineSentinelCharactersForChangedLines_(e,r)},e.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(Number.MAX_VALUE>t)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var r=this.codeMirror.lineCount();r>e+1&&this.lineIsListItemOrIndented_(e+1);)e++;for(var n=[1,1,1,1,1,1,1],i=this.codeMirror,o=t;e>=o;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),s.length>0)for(var h=s.indexOf(f);h>=0;){for(var u=h;s.length>h&&s[h]===f;){for(var c=i.findMarksAt({line:o,ch:h}),p=0;c.length>p;p++)c[p].isForLineSentinel&&c[p].clear();h++}this.markLineSentinelCharacters_(o,u,h,n),h=s.indexOf(f,h)}else for(p=0;n.length>p;p++)n[p]=1}},e.prototype.markLineSentinelCharacters_=function(t,e,r,n){var i=this.codeMirror,o=null,s=null,a=function(){var t=s.find();return t?t.from.line:null};if(0===e){var u=this.getLineAttributes_(t),c=u[h.LIST_TYPE],p=u[h.LINE_INDENT]||0;c&&0===p&&(p=1),p>=n.length&&(p=n.length-1),"o"===c?(o=this.makeOrderedListElement_(n[p]),n[p]++):"u"===c?(o=this.makeUnorderedListElement_(),n[p]=1):"t"===c?(o=this.makeTodoListElement_(!1,a),n[p]=1):"tc"===c&&(o=this.makeTodoListElement_(!0,a),n[p]=1);var l=this.getClassNameForAttributes_(u);""!==l&&this.codeMirror.addLineClass(t,"text",l);for(var f=p+1;n.length>f;f++)n[f]=1}var d={inclusiveLeft:!0,collapsed:!0};o&&(d.replacedWith=o);var s=i.markText({line:t,ch:e},{line:t,ch:r},d);s.isForLineSentinel=!0},e.prototype.makeOrderedListElement_=function(t){return a.elt("div",t+".",{style:"margin-left: -20px; display:inline-block; width:15px;"})},e.prototype.makeUnorderedListElement_=function(){return a.elt("div","•",{style:"margin-left: -20px; display:inline-block; width:15px;"})},e.prototype.toggleTodo=function(t){var e,r=h.LIST_TYPE,n=this.getCurrentLineAttributes_();r in n&&("t"===n[r]||"tc"===n[r])?"t"===n[r]?e="tc":"tc"===n[r]&&(e=t?"t":!1):e="t",this.setLineAttribute(r,e)},e.prototype.makeTodoListElement_=function(t,e){var r={type:"checkbox",style:"margin-left: -20px; display:inline-block; width:15px; margin-top: -2px;"};t&&(r.checked=!0);var n=a.elt("input",!1,r);return n.onclick=function(t){t.preventDefault(),this.codeMirror.setCursor({line:e(),ch:0}),this.toggleTodo(!0)}.bind(this),n},e.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return(e[h.LIST_TYPE]||!1)!==!1||0!==(e[h.LINE_INDENT]||0)},e.prototype.onCursorActivity_=function(){this.updateCurrentAttributes_()},e.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},e.prototype.updateCurrentAttributes_=function(){var e,r=this.codeMirror,n=r.indexFromPos(r.getCursor("anchor")),i=r.indexFromPos(r.getCursor("head"));e=n>i?i+1:i;var o=this.annotationList_.getAnnotatedSpansForPos(e);this.currentAttributes_={};var s={};o.length>0&&!(h.LINE_SENTINEL in o[0].annotation.attributes)?s=o[0].annotation.attributes:o.length>1&&(t.utils.assert(!(h.LINE_SENTINEL in o[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),s=o[1].annotation.attributes);for(var a in s)this.currentAttributes_[a]=s[a];delete this.currentAttributes_.l,delete this.currentAttributes_.lt},e.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),r=t.getCursor("head"),n=r.line;return 0===r.ch&&e.line<r.line&&n--,this.getLineAttributes_(n)},e.prototype.getLineAttributes_=function(e){var r={},n=this.codeMirror.getLine(e);if(n.length>0&&n[0]===f){var i=this.codeMirror.indexFromPos({line:e,ch:0}),o=this.annotationList_.getAnnotatedSpansForSpan(new s(i,1));t.utils.assert(1===o.length);for(var a in o[0].annotation.attributes)r[a]=o[0].annotation.attributes[a]}return r},e.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new s(0,this.end()),function(){return new r({})})},e.prototype.newline=function(){var t=this.codeMirror;if(this.emptySelection_()){var e=t.getCursor("head").line,r=this.getLineAttributes_(e),n=r[h.LIST_TYPE];n&&1===t.getLine(e).length?this.updateLineAttributes(e,e,function(t){delete t[h.LIST_TYPE],delete t[h.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),n&&this.updateLineAttributes(e+1,e+1,function(t){for(var e in r)t[e]=r[e];"tc"===n&&(t[h.LIST_TYPE]="t")}))}else t.replaceSelection("\n","end","+input")},e.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),r=this.getLineAttributes_(e.line),n=r[h.LIST_TYPE],i=r[h.LINE_INDENT],o=this.emptySelection_()&&1===e.ch;o&&n?this.updateLineAttributes(e.line,e.line,function(t){delete t[h.LIST_TYPE],delete t[h.LINE_INDENT]}):o&&i&&i>0?this.updateLineAttributes(e.line,e.line,function(t){t[h.LINE_INDENT]--}):t.deleteH(-1,"char")},e.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),r=t.getLine(e.line),n=this.areLineSentinelCharacters_(r),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&i[0]===f?t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"):t.deleteH(1,"char")},e.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[h.LINE_INDENT],r=t[h.LIST_TYPE];e&&6>e?t[h.LINE_INDENT]++:t[h.LINE_INDENT]=r?2:1})},e.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[h.LINE_INDENT],r=t[h.LIST_TYPE];e&&e>1?t[h.LINE_INDENT]=e-1:(t[h.LINE_INDENT]=!1,r&&(t[h.LIST_TYPE]=!1))})},e.prototype.getText=function(){return this.codeMirror.getValue().replace(RegExp(f,"g"),"")},e.prototype.areLineSentinelCharacters_=function(t){for(var e=0;t.length>e;e++)if(t[e]!==f)return!1;return!0},r.prototype.equals=function(t){if(!(t instanceof r))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},e}();var t=t||{};t.RichTextCodeMirrorAdapter=function(){"use strict";function e(t){this.rtcm=t,this.cm=t.codeMirror,s(this,"onChange"),s(this,"onAttributesChange"),s(this,"onCursorActivity"),s(this,"onFocus"),s(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function r(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function n(t,e){return 0===r(t,e)}function i(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function o(t,e){if(!t)throw Error(e||"assertion error")}function s(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function a(t){for(var e in t)return!1;return!0}var h=t.TextOperation,u=t.WrappedOperation,c=t.Cursor;e.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},e.operationFromCodeMirrorChange=function(t,e){for(var r=[],n=0;t;)r[n++]=t,t=t.next;var o=i(e),s=(new h).retain(o),a=(new h).retain(o);for(n=r.length-1;n>=0;n--){t=r[n];var u=t.start,c=o-u-t.text.length;s=(new h).retain(u)["delete"](t.removed.length).insert(t.text,t.attributes).retain(c).compose(s),a=a.compose((new h).retain(u)["delete"](t.text.length).insert(t.removed,t.removedAttributes).retain(c)),o+=t.removed.length-t.text.length}return[s,a]},e.operationFromAttributesChange=function(t,e){for(var r=i(e),n=new h,s=new h,a=0;t;){var u=t.start-a;o(u>=0),n.retain(u),s.retain(u);var c=t.end-t.start;n.retain(c,t.attributes),s.retain(c,t.attributesInverse),a=t.start+c,t=t.next}return n.retain(r-a),s.retain(r-a),[n,s]},e.applyOperationToCodeMirror=function(t,e){e.codeMirror.operation(function(){for(var r=t.ops,n=0,i=0,o=r.length;o>i;i++){var s=r[i];s.isRetain()?(a(s.attributes)||e.updateTextAttributes(n,n+s.chars,function(t){for(var e in s.attributes)s.attributes[e]===!1?delete t[e]:t[e]=s.attributes[e]},"RTCMADAPTER"),n+=s.chars):s.isInsert()?(e.insertText(n,s.text,s.attributes,"RTCMADAPTER"),n+=s.text.length):s.isDelete()&&e.removeText(n,n+s.chars,"RTCMADAPTER")}})},e.prototype.registerCallbacks=function(t){this.callbacks=t},e.prototype.onChange=function(t,r){if("RTCMADAPTER"!==r.origin){var n=e.operationFromCodeMirrorChange(r,this.cm);this.trigger("change",n[0],n[1])}},e.prototype.onAttributesChange=function(t,r){if("RTCMADAPTER"!==r.origin){var n=e.operationFromAttributesChange(r,this.cm);this.trigger("change",n[0],n[1])}},e.prototype.onCursorActivity=e.prototype.onFocus=function(){this.trigger("cursorActivity")},e.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},e.prototype.getValue=function(){return this.cm.getValue()},e.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),i=e.indexFromPos(r);if(e.somethingSelected()){var o=e.getCursor(!0),s=n(r,o)?e.getCursor(!1):o;t=e.indexFromPos(s)}else t=i;return new c(i,t)},e.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))};var p=function(){if("undefined"!=typeof document){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var r=e.sheet;return function(e){t[e]||(t[e]=!0,r.insertRule(e,(r.cssRules||r.rules).length))}}}();return e.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var i=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(0>t.position||t.position>i||0>t.selectionEnd||t.selectionEnd>i)){if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),s=document.createElement("pre");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.innerHTML="&nbsp;",s.style.borderLeftColor=e,s.style.height=.9*(o.bottom-o.top)+"px",s.style.marginTop=o.top-o.bottom+"px",s.setAttribute("data-clientid",r),s.style.zIndex=0,this.cm.addWidget(n,s,!1),{clear:function(){var t=s.parentNode;t&&t.removeChild(s)}}}var a="selection-"+e.replace("#",""),h="."+a+" { background: "+e+"; }";p(h);var u,c;return t.selectionEnd>t.position?(u=n,c=this.cm.posFromIndex(t.selectionEnd)):(u=this.cm.posFromIndex(t.selectionEnd),c=n),this.cm.markText(u,c,{className:a})}}},e.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},e.prototype.applyOperation=function(t){e.applyOperationToCodeMirror(t,this.rtcm)},e.prototype.registerUndo=function(t){this.cm.undo=t},e.prototype.registerRedo=function(t){this.cm.redo=t},e.prototype.invertOperation=function(t){for(var e,r,n=0,i=this.rtcm.codeMirror,o=new h,s=0;t.wrapped.ops.length>s;s++){var c=t.wrapped.ops[s];if(c.isRetain())if(a(c.attributes))o.retain(c.chars),n+=c.chars;else for(e=this.rtcm.getAttributeSpans(n,n+c.chars),r=0;e.length>r;r++){var p={};for(var l in c.attributes){var f=c.attributes[l],d=e[r].attributes[l];f===!1?d&&(p[l]=d):f!==d&&(p[l]=d||!1)}o.retain(e[r].length,p),n+=e[r].length}else if(c.isInsert())o["delete"](c.text.length);else if(c.isDelete()){var g=i.getRange(i.posFromIndex(n),i.posFromIndex(n+c.chars));e=this.rtcm.getAttributeSpans(n,n+c.chars);var v=0;for(r=0;e.length>r;r++)o.insert(g.substr(v,e[r].length),e[r].attributes),v+=e[r].length;n+=c.chars}}return new u(o,t.meta.invert())},e}();var t=t||{};t.Formatting=function(){function e(t){return this instanceof e?(this.attributes=t||{},void 0):new e(t)}var r=t.AttributeConstants;return e.prototype.cloneWithNewAttribute_=function(t,r){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return r===!1?delete n[t]:n[t]=r,new e(n)},e.prototype.bold=function(t){return this.cloneWithNewAttribute_(r.BOLD,t)},e.prototype.italic=function(t){return this.cloneWithNewAttribute_(r.ITALIC,t)},e.prototype.underline=function(t){return this.cloneWithNewAttribute_(r.UNDERLINE,t)},e.prototype.font=function(t){return this.cloneWithNewAttribute_(r.FONT,t)},e.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(r.FONT_SIZE,t)},e.prototype.color=function(t){return this.cloneWithNewAttribute_(r.COLOR,t)},e}();var t=t||{};t.Text=function(){function e(r,n){return this instanceof e?(this.text=r,this.formatting=n||t.Formatting(),void 0):new e(r,n)}return e}();var t=t||{};t.LineFormatting=function(){function e(t){return this instanceof e?(this.attributes=t||{},this.attributes[r.LINE_SENTINEL]=!0,void 0):new e(t)}var r=t.AttributeConstants;return e.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},e.prototype.cloneWithNewAttribute_=function(t,r){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return r===!1?delete n[t]:n[t]=r,new e(n)},e.prototype.indent=function(t){return this.cloneWithNewAttribute_(r.LINE_INDENT,t)},e.prototype.listItem=function(e){return t.utils.assert(e===!1||"u"===e||"o"===e||"t"===e||"tc"===e),this.cloneWithNewAttribute_(r.LIST_TYPE,e)},e.prototype.getIndent=function(){return this.attributes[r.LINE_INDENT]||0},e.prototype.getListItem=function(){return this.attributes[r.LIST_TYPE]||!1},e}();var t=t||{};t.Line=function(){function e(r,n){return this instanceof e?("[object Array]"!==Object.prototype.toString.call(r)&&(r=r===void 0?[]:[r]),this.textPieces=r,this.formatting=n||t.LineFormatting(),void 0):new e(r,n)}return e}();var t=t||{};t.ParseHtml=function(){function e(e,r,n){this.listType=e||h.UNORDERED,this.lineFormatting=r||t.LineFormatting(),this.textFormatting=n||t.Formatting()}function r(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}function n(t){var n=document.createElement("div");n.innerHTML=t;var o=new r,s=new e;return i(n,s,o),o.lines}function i(e,r,n){switch(e.nodeType){case Node.TEXT_NODE:var i=e.nodeValue.replace(/\s+/g," ");n.currentLine.push(t.Text(i,r.textFormatting));break;case Node.ELEMENT_NODE:var u=e.getAttribute("style")||"";switch(r=r.withTextFormatting(a(r.textFormatting,u)),e.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":n.newlineIfNonEmpty(r),o(e,r,n),n.newlineIfNonEmpty(r);break;case"b":case"strong":o(e,r.withTextFormatting(r.textFormatting.bold(!0)),n);break;case"u":o(e,r.withTextFormatting(r.textFormatting.underline(!0)),n);break;case"i":case"em":o(e,r.withTextFormatting(r.textFormatting.italic(!0)),n);break;case"font":var c=e.getAttribute("face"),p=e.getAttribute("color"),l=parseInt(e.getAttribute("size"));c&&(r=r.withTextFormatting(r.textFormatting.font(c))),p&&(r=r.withTextFormatting(r.textFormatting.color(p))),l&&(r=r.withTextFormatting(r.textFormatting.fontSize(l))),o(e,r,n);break;case"br":n.newline(r);break;case"ul":n.newlineIfNonEmptyOrListItem(r),o(e,r.withListType(h.UNORDERED).withIncreasedIndent(),n),n.newlineIfNonEmpty(r);break;case"ol":n.newlineIfNonEmptyOrListItem(r),o(e,r.withListType(h.ORDERED).withIncreasedIndent(),n),n.newlineIfNonEmpty(r);break;case"li":s(e,r,n);break;default:o(e,r,n)}break;default:}}function o(t,e,r){if(t.hasChildNodes())for(var n=0;t.childNodes.length>n;n++)i(t.childNodes[n],e,r)}function s(t,e,r){r.newlineIfNonEmptyOrListItem(e),r.makeListItem(e.listType);var n=r.currentLine;o(t,e,r),(n===r.currentLine||r.currentLine.length>0)&&r.newline(e)}function a(t,e){for(var r=e.split(";"),n=0;r.length>n;n++){var i=r[n].split(":");if(2===i.length){var o=i[0].trim().toLowerCase(),s=i[1].trim();switch(o){case"text-decoration":var a=s.indexOf("underline")>=0;t=t.underline(a);break;case"font-weight":var h="bold"===s||parseInt(s)>=600;t=t.bold(h);break;case"font-style":var u="italic"===s||"oblique"===s;t=t.italic(u);break;case"color":t=t.color(s.toLowerCase());break;case"font-size":switch(s){case"xx-small":t=t.fontSize(9);break;case"x-small":t=t.fontSize(10);break;case"small":t=t.fontSize(12);break;case"medium":t=t.fontSize(14);break;case"large":t=t.fontSize(18);break;case"x-large":t=t.fontSize(24);break;case"xx-large":t=t.fontSize(32);break;default:t=t.fontSize(parseInt(s))}break;case"font-family":var c=s.split(",")[0].trim();c=c.replace(/['"]/g,""),c=c.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),t=t.font(c)}}}return t}var h=t.LineFormatting.LIST_TYPE;return e.prototype.withTextFormatting=function(t){return new e(this.listType,this.lineFormatting,t)},e.prototype.withLineFormatting=function(t){return new e(this.listType,t,this.textFormatting)},e.prototype.withListType=function(t){return new e(t,this.lineFormatting,this.textFormatting)},e.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new e(this.listType,t,this.textFormatting)},r.prototype.newlineIfNonEmpty=function(t){this.currentLine.length>0&&this.newline(t)},r.prototype.newlineIfNonEmptyOrListItem=function(t){(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(t)},r.prototype.newline=function(e){var r=e.lineFormatting;null!==this.currentLineListItemType&&(r=r.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(t.Line(this.currentLine,r)),this.currentLine=[]},r.prototype.makeListItem=function(t){this.currentLineListItemType=t},r.prototype.isListItem=function(){return null!==this.currentLineListItemType},n}();var t=t||{};return t.Firepad=function(e){function r(t,e,i){if(!(this instanceof r))return new r(t,e,i);if(!d)throw Error("Couldn't find CodeMirror.  Did you forget to include codemirror.js?");if(e instanceof d){this.codeMirror_=e;var o=this.codeMirror_.getValue();if(""!==o)throw Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else this.codeMirror_=new d(e);var h=this.codeMirror_.getWrapperElement();this.firepadWrapper_=l.elt("div",null,{"class":"firepad"}),h.parentNode.replaceChild(this.firepadWrapper_,h),this.firepadWrapper_.appendChild(h),this.codeMirror_.firepad=this,this.options_=i||{},this.getOption("richTextShortcuts",!1)&&(d.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.addPoweredByLogo_(),this.codeMirror_.refresh();var p=this.getOption("userId",t.push().name()),f=this.getOption("userColor",n(p));this.richTextCodeMirror_=new a(this.codeMirror_,{cssPrefix:"firepad-"}),this.firebaseAdapter_=new u(t,p,f),this.cmAdapter_=new s(this.richTextCodeMirror_),this.client_=new c(this.firebaseAdapter_,this.cmAdapter_);var g=this;this.firebaseAdapter_.on("ready",function(){g.ready_=!0,g.trigger("ready")})}function n(t){for(var e=1,r=0;t.length>r;r++)e=17*(e+t.charCodeAt(r))%360;var n=e/360;return o(n,1,.85)}function i(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}function o(t,e,r){if(0===e)return i(r,r,r);var n=.5>r?r*(1+e):r+e-e*r,o=2*r-n,s=function(t){return 0>t&&(t+=1),t>1&&(t-=1),1>6*t?o+6*(n-o)*t:1>2*t?n:2>3*t?o+6*(n-o)*(2/3-t):o};return i(s(t+1/3),s(t),s(t-1/3))}var s=t.RichTextCodeMirrorAdapter,a=t.RichTextCodeMirror,h=t.RichTextToolbar,u=t.FirebaseAdapter,c=t.EditorClient,p=t.AttributeConstants,l=t.utils,f=t.LineFormatting.LIST_TYPE,d=e.CodeMirror;return l.makeEventEmitter(r),r.fromCodeMirror=r,r.prototype.dispose=function(){this.zombie_=!0;var t=this.codeMirror_.getWrapperElement();this.firepadWrapper_.removeChild(t),this.firepadWrapper_.parentNode.replaceChild(t,this.firepadWrapper_),this.codeMirror_.firepad=null,"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.cmAdapter_.detach(),this.richTextCodeMirror_.detach()},r.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},r.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},r.prototype.getText=function(){return this.assertReady_("getText"),this.richTextCodeMirror_.getText()},r.prototype.setText=function(e){function r(t,e){h.richTextCodeMirror_.insertText(o,t,e||null),o+=t.length,s="\n"===t[t.length-1]}function n(e){if(e instanceof t.Text)r(e.text,e.formatting.attributes);else{if("string"!=typeof e)throw console.error("Can't insert into firepad",e),"Can't insert into firepad: "+e;r(e)}}function i(t){s||r("\n"),r(a.LineSentinelCharacter,t.formatting.attributes);for(var e=0;t.textPieces.length>e;e++)n(t.textPieces[e]);r("\n")}this.assertReady_("setText"),"[object Array]"!==Object.prototype.toString.call(e)&&(e=[e]),this.codeMirror_.setValue("");for(var o=0,s=!0,h=this,u=0;e.length>u;u++)e[u]instanceof t.Line?i(e[u]):n(e[u])},r.prototype.getHtml=function(){function e(t){return t===f.ORDERED?"<ol>":"<ul>"}function r(t){return t===f.ORDERED?"</ol>":"</ul>"}for(var n=this.firebaseAdapter_.getDocument(),i="",o=!0,s=[],a=!1,h=0,u=n.ops[h];u;){l.assert(u.isInsert());var c=u.attributes;if(o){o=!1;var d=0,g=null;p.LINE_SENTINEL in c&&(d=c[p.LINE_INDENT]||0,g=c[p.LIST_TYPE]||null),g&&(d=d||1),a&&(i+="</li>",a=!1),l.assert(d>=0,"Indent must not be negative.");for(;s.length>d||d===s.length&&null!==g&&g!==s[s.length-1];)i+=r(s.pop());for(;d>s.length;){var v=g||f.UNORDERED;i+=e(v),s.push(v)}g&&(i+="<li>",a=!0)}if(p.LINE_SENTINEL in c)u=n.ops[++h];else{var m="",y="";for(var b in c){var _,x,C=c[b];b===p.BOLD||b===p.ITALIC||b===p.UNDERLINE?(l.assert(C===!0),_=x=b):b===p.FONT_SIZE?(_='span style="font-size: '+C,_+="string"!=typeof C||-1===C.indexOf("px",C.length-2)?'px"':'"',x="span"):b===p.FONT?(_='span style="font-family: '+C+'"',x="span"):b===p.COLOR?(_='span style="color: '+C+'"',x="span"):l.log(!1,"Encountered unknown attribute while rendering html: "+b),_&&(m+="<"+_+">"),x&&(y="</"+x+">"+y)}var L=u.text,E=L.indexOf("\n");E>=0?(o=!0,L.length-1>E?(u=new t.TextOp("insert",L.substr(E+1),c),L=L.substr(0,E+1)):u=n.ops[++h]):u=n.ops[++h],i+=m+this.textToHtml_(L)+y}}for(a&&(i+="</li>");s.length>0;)i+=r(s.pop());return i},r.prototype.textToHtml_=function(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />")},r.prototype.setHtml=function(e){var r=t.ParseHtml(e);this.setText(r)},r.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},r.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(p.BOLD),this.codeMirror_.focus()},r.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(p.ITALIC),this.codeMirror_.focus()},r.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(p.UNDERLINE),this.codeMirror_.focus()},r.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(p.FONT_SIZE,t),this.codeMirror_.focus()},r.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(p.FONT,t),this.codeMirror_.focus()},r.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(p.COLOR,t),this.codeMirror_.focus()},r.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(p.LIST_TYPE,"o"),this.codeMirror_.focus()},r.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(p.LIST_TYPE,"u"),this.codeMirror_.focus()
},r.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},r.prototype.newline=function(){this.richTextCodeMirror_.newline()},r.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},r.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},r.prototype.indent=function(){this.richTextCodeMirror_.indent()},r.prototype.unindent=function(){this.richTextCodeMirror_.unindent()},r.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},r.prototype.assertReady_=function(t){if(!this.ready_)throw Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw Error("You can't use a Firepad after calling dispose()!")},r.prototype.addToolbar_=function(){var t=new h;t.on("bold",this.bold,this),t.on("italic",this.italic,this),t.on("underline",this.underline,this),t.on("font-size",this.fontSize,this),t.on("font",this.font,this),t.on("color",this.color,this),t.on("ordered-list",this.orderedList,this),t.on("unordered-list",this.unorderedList,this),t.on("todo",this.todo,this),this.firepadWrapper_.insertBefore(t.element(),this.firepadWrapper_.firstChild)},r.prototype.addPoweredByLogo_=function(){var t=l.elt("a",null,{"class":"powered-by-firepad"});t.setAttribute("href","http://www.firepad.io/"),t.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(t)},r.prototype.initializeKeyMap_=function(){function t(t){return function(e){t.call(e.firepad)}}d.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},r}(this),t.Firepad.Formatting=t.Formatting,t.Firepad.Text=t.Text,t.Firepad.LineFormatting=t.LineFormatting,t.Firepad.Line=t.Line,t.Firepad.TextOperation=t.TextOperation,t.Firepad}();